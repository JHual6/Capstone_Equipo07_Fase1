/* SCRIPT C - VERSIÓN 3 (DEFINITIVA)
   Motor de Simulación con "Canasta de Compras"
*/

CREATE OR REPLACE FUNCTION simular_negocio_realista(fecha_inicio DATE, fecha_fin DATE)
RETURNS VOID AS $$
DECLARE
    dia_actual DATE := fecha_inicio;
    
    -- Variables Generales Venta
    v_meta_diaria INT;
    v_vendido_hoy INT;
    v_id_nueva_venta INT;
    v_total_boleta INT;
    
    -- Variables de "Carrito de Compras"
    v_num_items_en_carrito INT;
    v_items_agregados INT;
    
    -- Variables de Producto
    v_producto_id INT;
    v_precio_unitario INT;
    v_categoria_prod VARCHAR(100);
    v_cantidad_producto INT;
    v_subtotal_linea INT;
    
    -- Variables Ambientales/Logística
    v_hora_apertura TIME;
    v_hora_cierre TIME;
    v_hora_venta TIME;
    v_clima_id INT;
    v_desc_clima TEXT;
    v_es_viento_fuerte BOOLEAN;
    
    -- Variables Compras
    es_martes BOOLEAN;
    ventas_semana_ant INT;
    monto_compra INT;
    v_id_compra INT;

BEGIN
    -- Validación de seguridad
    IF NOT EXISTS (SELECT 1 FROM Producto) THEN
        RAISE EXCEPTION 'Error: La tabla Producto está vacía. Carga productos antes de simular.';
    END IF;

    WHILE dia_actual <= fecha_fin LOOP
        
        -- 1. DEFINIR HORARIOS (Dinámico según Clima)
        SELECT MIN(hora_clima), MAX(hora_clima) INTO v_hora_apertura, v_hora_cierre
        FROM Clima WHERE fecha_clima = dia_actual;

        IF v_hora_apertura IS NULL THEN 
            dia_actual := dia_actual + 1; 
            CONTINUE; 
        END IF;

        -- 2. LOGICA DE REABASTECIMIENTO (Martes)
        es_martes := (EXTRACT(DOW FROM dia_actual) = 2);
        IF es_martes THEN
            SELECT COALESCE(SUM(total_ven), 0) INTO ventas_semana_ant 
            FROM Ventas WHERE fecha_ven BETWEEN dia_actual - 7 AND dia_actual - 1;
            
            monto_compra := ventas_semana_ant * 1.15;
            
            IF (EXTRACT(MONTH FROM dia_actual) = 2 AND EXTRACT(DAY FROM dia_actual) < 14) OR
               (EXTRACT(MONTH FROM dia_actual) = 10 AND EXTRACT(DAY FROM dia_actual) > 25) THEN
                monto_compra := monto_compra * 3;
            END IF;
            
            IF monto_compra > 0 THEN
                INSERT INTO Compras (fecha_comp, cantidad_comp, precio_comp, color_lote_comp, id_prov)
                VALUES (dia_actual, 20, monto_compra, 'Surtido Semanal', 1)
                RETURNING id_comp INTO v_id_compra;
                
                INSERT INTO Detalle_Compras (cant_paq_flores_detcom, cant_paq_detcom, cant_paq_defecto_detcom, precio_paq_detcom, id_flor, id_comp)
                VALUES (20, 20, 0, (monto_compra/20)::INT, 1, v_id_compra);
            END IF;
        END IF;

        -- 3. OBTENER META DEL DÍA
        SELECT total_venta_estimado INTO v_meta_diaria 
        FROM temp_ventas_totales WHERE fecha_dia = dia_actual;
        
        IF v_meta_diaria IS NULL THEN v_meta_diaria := 0; END IF;
        v_vendido_hoy := 0;

        -- Clima para decisiones de producto
        SELECT desc_clima INTO v_desc_clima 
        FROM Clima WHERE fecha_clima = dia_actual AND hora_clima >= '12:00:00' LIMIT 1;
        v_es_viento_fuerte := (v_desc_clima LIKE '%VIENTO FUERTE%');

        -- BUCLE DE VENTAS (CLIENTES ENTRANDO)
        WHILE v_vendido_hoy < v_meta_diaria LOOP
            
            -- A. Definir hora y buscar Clima de esa hora
            v_hora_venta := v_hora_apertura + (random() * (v_hora_cierre - v_hora_apertura));
            SELECT id_clima INTO v_clima_id FROM Clima 
            WHERE fecha_clima = dia_actual 
            ORDER BY ABS(EXTRACT(EPOCH FROM (hora_clima - v_hora_venta))) ASC LIMIT 1;

            -- B. CREAR CABECERA (Total 0 temporalmente)
            INSERT INTO Ventas (fecha_ven, hora_ven, cantidad_ven, total_ven, id_cli, id_clima, id_tipag, boleta_ven, desc_ven)
            VALUES (dia_actual, v_hora_venta, 0, 0, 1, v_clima_id, 1, 'BOL-'||to_char(dia_actual, 'YYYYMMDD')||'-'||floor(random()*1000), 'Venta Cliente')
            RETURNING id_ven INTO v_id_nueva_venta;

            -- C. LLENAR EL CARRITO (Detalle Ventas)
            IF random() < 0.6 THEN v_num_items_en_carrito := 1;
            ELSIF random() < 0.9 THEN v_num_items_en_carrito := 2;
            ELSE v_num_items_en_carrito := floor(random() * 2 + 3)::INT; 
            END IF;

            v_items_agregados := 0;
            v_total_boleta := 0;

            WHILE v_items_agregados < v_num_items_en_carrito LOOP
                
                -- D. ELEGIR PRODUCTO Y CANTIDAD
                IF v_es_viento_fuerte AND random() < 0.8 THEN 
                     SELECT id_prod, 12000, cat_prod INTO v_producto_id, v_precio_unitario, v_categoria_prod
                     FROM Producto WHERE cat_prod != 'Arreglos' ORDER BY random() LIMIT 1;
                ELSE
                     SELECT id_prod, 25000, cat_prod INTO v_producto_id, v_precio_unitario, v_categoria_prod
                     FROM Producto ORDER BY random() LIMIT 1;
                END IF;
                
                IF v_producto_id IS NULL THEN 
                    SELECT id_prod, 10000, 'Flores' INTO v_producto_id, v_precio_unitario, v_categoria_prod FROM Producto LIMIT 1;
                END IF;

                IF v_categoria_prod = 'Arreglos' THEN
                    v_cantidad_producto := 1;
                    v_precio_unitario := v_precio_unitario; -- Mantiene el precio del arreglo
                ELSE
                    v_cantidad_producto := floor(random() * 6 + 1)::INT; 
                    v_precio_unitario := 2500; -- Ajusta a precio por unidad/flor
                END IF;

                v_subtotal_linea := v_precio_unitario * v_cantidad_producto;

                -- E. INSERTAR DETALLE
                INSERT INTO Detalle_Ventas (cant_detven, preciou_detven, precio_detven, id_prod, id_ven)
                VALUES (v_cantidad_producto, v_precio_unitario, v_subtotal_linea, v_producto_id, v_id_nueva_venta);

                v_total_boleta := v_total_boleta + v_subtotal_linea;
                v_items_agregados := v_items_agregados + 1;
                
            END LOOP; -- Fin llenado de carrito

            -- F. ACTUALIZAR CABECERA CON EL TOTAL REAL
            UPDATE Ventas 
            SET total_ven = v_total_boleta, 
                cantidad_ven = v_num_items_en_carrito 
            WHERE id_ven = v_id_nueva_venta;

            v_vendido_hoy := v_vendido_hoy + v_total_boleta;
            
            -- G. Freno de emergencia
            IF v_vendido_hoy > (v_meta_diaria * 1.1) THEN EXIT; END IF; 

        END LOOP; -- Fin bucle de ventas del día
        
        dia_actual := dia_actual + 1;
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- EJECUTAR LA SIMULACIÓN V3
SELECT simular_negocio_realista('2023-02-01', '2024-12-31');